import 'dart:typed_data';
import 'package:test/test.dart';
import 'dart:io' show Directory;
import 'package:path/path.dart' as path;
import 'package:file_picker/file_picker.dart' show PlatformFile;
import 'package:xml/xml.dart';

import 'package:authorityeditor/authority/authority.dart';
import 'package:authorityeditor/authority/src/session/paragraph.dart';

void main() {
  final rda = Session();
  final examplePath = path.join(
    Directory.current.path,
    '..',
    'data',
    'SRNSW_example.xml',
  );
  final doc = rda.load(
    PlatformFile(name: "SRNSW_example.xml", path: examplePath, size: 12036),
  );
  final XmlDocument paraDoc = XmlDocument.parse(testParas);
  test('doc index', () {
    expect(doc, 0);
  });

  test('validate the doc', () {
    final valid = rda.valid(doc);
    expect(valid, true);
  });
  test('print the doc', () {
    final str = rda.asString(doc);
    expect(str.length, 11022);
  });
  test('tree', () {
    final tree = rda.tree(doc, Counter());
    expect(tree.length, 3);
  });
  test('paragraphs', () {
    final paras = deserialiseParagraphs(Uint8List.fromList(paraByts));
    expect(paras!.length, 6);
    final sparas = serialiseParagraphs(
      paraDoc.rootElement.childElements.toList(),
    );
    expect(sparas == null, false);
    expect(sparas!.toList(), paraByts);
    final dparas = deserialiseParagraphs(sparas);
    expect(dparas!.length, 6);
  });
  test('set current', () {
    rda.setCurrent(doc, (NodeType.termType, 0));
  });
}

final testParas = '''
<Test xmlns="http://www.records.nsw.gov.au/schemas/RDA">
  <Paragraph>Hello world.</Paragraph>
  <Paragraph>This is a <Emphasis>test</Emphasis>. I want to use all the<Source>formatting</Source>. Including<Source url="http://www.world.com">links</Source>.</Paragraph>
  <Paragraph>And lists:
    <List>
      <Item>One item</Item>
      <Item>Two item, this one with<Emphasis>emphasis</Emphasis></Item>
    </List>
  </Paragraph>
  <Paragraph>And a final para!</Paragraph>
  <Paragraph>And a bad char Officeâ€™s</Paragraph>
  <Paragraph><Source /></Paragraph>
</Test> 
''';

List<int> paraByts = [
  0x06,
  0x01,
  0x00,
  0x0d,
  0x00,
  0x48,
  0x65,
  0x6c,
  0x6c,
  0x6f,
  0x20,
  0x77,
  0x6f,
  0x72,
  0x6c,
  0x64,
  0x2e,
  0x00,
  0x07,
  0x00,
  0x0b,
  0x00,
  0x54,
  0x68,
  0x69,
  0x73,
  0x20,
  0x69,
  0x73,
  0x20,
  0x61,
  0x20,
  0x00,
  0x02,
  0x05,
  0x00,
  0x74,
  0x65,
  0x73,
  0x74,
  0x00,
  0x00,
  0x18,
  0x00,
  0x2e,
  0x20,
  0x49,
  0x20,
  0x77,
  0x61,
  0x6e,
  0x74,
  0x20,
  0x74,
  0x6f,
  0x20,
  0x75,
  0x73,
  0x65,
  0x20,
  0x61,
  0x6c,
  0x6c,
  0x20,
  0x74,
  0x68,
  0x65,
  0x00,
  0x01,
  0x0b,
  0x00,
  0x66,
  0x6f,
  0x72,
  0x6d,
  0x61,
  0x74,
  0x74,
  0x69,
  0x6e,
  0x67,
  0x00,
  0x00,
  0x0c,
  0x00,
  0x2e,
  0x20,
  0x49,
  0x6e,
  0x63,
  0x6c,
  0x75,
  0x64,
  0x69,
  0x6e,
  0x67,
  0x00,
  0x03,
  0x15,
  0x00,
  0x68,
  0x74,
  0x74,
  0x70,
  0x3a,
  0x2f,
  0x2f,
  0x77,
  0x77,
  0x77,
  0x2e,
  0x77,
  0x6f,
  0x72,
  0x6c,
  0x64,
  0x2e,
  0x63,
  0x6f,
  0x6d,
  0x00,
  0x06,
  0x00,
  0x6c,
  0x69,
  0x6e,
  0x6b,
  0x73,
  0x00,
  0x00,
  0x02,
  0x00,
  0x2e,
  0x00,
  0x02,
  0x00,
  0x10,
  0x00,
  0x41,
  0x6e,
  0x64,
  0x20,
  0x6c,
  0x69,
  0x73,
  0x74,
  0x73,
  0x3a,
  0x0a,
  0x20,
  0x20,
  0x20,
  0x20,
  0x00,
  0x04,
  0x02,
  0x05,
  0x01,
  0x00,
  0x09,
  0x00,
  0x4f,
  0x6e,
  0x65,
  0x20,
  0x69,
  0x74,
  0x65,
  0x6d,
  0x00,
  0x05,
  0x02,
  0x00,
  0x18,
  0x00,
  0x54,
  0x77,
  0x6f,
  0x20,
  0x69,
  0x74,
  0x65,
  0x6d,
  0x2c,
  0x20,
  0x74,
  0x68,
  0x69,
  0x73,
  0x20,
  0x6f,
  0x6e,
  0x65,
  0x20,
  0x77,
  0x69,
  0x74,
  0x68,
  0x00,
  0x02,
  0x09,
  0x00,
  0x65,
  0x6d,
  0x70,
  0x68,
  0x61,
  0x73,
  0x69,
  0x73,
  0x00,
  0x01,
  0x00,
  0x12,
  0x00,
  0x41,
  0x6e,
  0x64,
  0x20,
  0x61,
  0x20,
  0x66,
  0x69,
  0x6e,
  0x61,
  0x6c,
  0x20,
  0x70,
  0x61,
  0x72,
  0x61,
  0x21,
  0x00,
  0x01,
  0x00,
  0x1a,
  0x00,
  0x41,
  0x6e,
  0x64,
  0x20,
  0x61,
  0x20,
  0x62,
  0x61,
  0x64,
  0x20,
  0x63,
  0x68,
  0x61,
  0x72,
  0x20,
  0x4f,
  0x66,
  0x66,
  0x69,
  0x63,
  0x65,
  0xe2,
  0x80,
  0x99,
  0x73,
  0x00,
  0x01,
  0x01,
  0x00,
  0x00,
];
